---
description: git diffを分析してコミットメッセージの草案を生成
allowed-tools: ["Bash(git:*)"]
---

# コミットメッセージ草案生成

git diffを分析して、適切なコミットメッセージを提案します。

## 厳守事項

- NEVER add "Generated by Claude Code" or similar signatures
- NEVER add "Co-Authored-By" lines
- コミットメッセージは**1行のみ**（subject line）を基本とする
- bodyは複雑な変更の場合のみ、ユーザーが要求した場合に追加

## 引数

`$ARGUMENTS`

| 入力 | 動作 |
|------|------|
| （空） | ステージ済み → 未ステージの順で差分を取得 |
| `--all` | 全ファイルをステージしてから分析 |
| `--ja` | 日本語でメッセージ生成（自動判定を上書き） |
| `--en` | 英語でメッセージ生成（自動判定を上書き） |
| `--issue=123` | Issue番号を追加（#123形式） |
| `--issue=JIRA-456` | Issue番号を追加（JIRA-456形式） |

複数オプションの組み合わせ可能: `/git:draft-commit --ja --issue=123`

---

## Step 1: リポジトリのコミット履歴を分析

まず `git log --oneline -20` を実行し、過去のコミットメッセージを分析:

### 判定項目

1. **言語判定**（`--ja`/`--en` 指定時はスキップ）
   - 日本語が多い → 日本語でメッセージ生成
   - 英語が多い → 英語でメッセージ生成
   - 混在 → 英語をデフォルト

2. **スタイル判定**
   - Conventional Commits形式（feat:, fix: など）が使われているか
   - emoji が使われているか
   - Issue番号の記載パターン（#123, JIRA-123 など）

### 出力例

```
📊 リポジトリ分析結果:
- 言語: 英語（直近20件中18件が英語）
- スタイル: Conventional Commits
- emoji: 使用なし
- Issue参照: #123 形式
```

---

## Step 2: 差分の取得

以下のコマンドで変更内容を確認:

1. `git status` - 変更ファイル一覧
2. `git diff --staged` - ステージ済みの変更（優先）
3. `git diff` - 未ステージの変更（ステージ済みがない場合）

### `--all` オプション指定時

`git add -A` を実行してから `git diff --staged` を取得

---

## Step 3: セキュリティチェック

差分の内容を分析し、機密情報が含まれていないかチェック:

### チェック対象

**機密情報:**
- APIキー（`sk-`, `pk_`, `api_key=`など）
- シークレットキー、アクセストークン
- パスワード（`password=`, `passwd=`など）
- データベース接続文字列
- 暗号化キー、証明書の秘密鍵
- AWSアクセスキー（`AKIA`で始まる）

### 除外対象（警告しない）

- 環境変数名のみ（`API_KEY=`のように値がない）
- プレースホルダー（`YOUR_API_KEY_HERE`, `xxx`, `***`など）
- コメントアウトされた例
- `.env.example` ファイル

### 検出時の動作

問題を検出した場合は警告を表示:

```
⚠️ セキュリティ警告:

以下のファイルに機密情報の可能性があります:
- src/config.ts:15 - "sk-proj-..." (OpenAI APIキーの可能性)
- .env:3 - "password=secret123" (パスワードの可能性)

コミット前に確認してください。
問題なければ続行します。
```

---

## Step 4: 変更内容の分析

変更を以下の観点で分類:

| プレフィックス | 用途 |
|---------------|------|
| feat | 新機能の追加 |
| fix | バグ修正 |
| refactor | リファクタリング（機能変更なし） |
| docs | ドキュメントのみの変更 |
| style | フォーマット変更（コードの意味に影響しない） |
| test | テストの追加・修正 |
| chore | ビルド・設定変更 |
| perf | パフォーマンス改善 |
| ci | CI設定の変更 |

### scope の決定

- 変更が1つのモジュール/ディレクトリに限定 → そのモジュール名
- 複数にまたがる → 省略または主要なもの

---

## Step 5: コミットメッセージ生成

Step 1で分析したリポジトリのスタイルに合わせてメッセージを生成。

### フォーマット (Conventional Commits)

**基本形式（1行のみ）:**
```
<type>(<scope>): <subject>
```

**例:**
```
feat(auth): add MFA support to login
fix(api): resolve null pointer exception
chore: update dependencies
```

### Issue番号の追加（`--issue` 指定時）

```
feat(auth): add MFA support (#123)
```

### 注意事項

- **署名やCo-Authored-Byは絶対に追加しない**
- subject lineは50文字以内を目安
- scopeは省略可能

---

## Step 6: 出力

以下の形式で出力:

```
📝 コミットメッセージ案:

feat(auth): add MFA support to login

💡 使用方法:

git commit -m "feat(auth): add MFA support to login"
```

**重要**: 署名やCo-Authored-Byは追加しない。メッセージは1行のみ。

---

## エラーハンドリング

### gitリポジトリでない場合

```
❌ エラー: このディレクトリはgitリポジトリではありません

`git init` でリポジトリを初期化するか、gitリポジトリ内で実行してください。
```

### 変更がない場合

```
⚠️ コミット対象の変更がありません

確認事項:
- `git status` で変更ファイルを確認
- `git add <file>` で変更をステージ
- または `/git:draft-commit --all` で全ファイルをステージ
```

### リモートが設定されていない場合

コミット履歴の分析は可能。言語判定のみ実行し、警告を表示:

```
ℹ️ リモートリポジトリが設定されていません。ローカルコミット履歴のみを分析します。
```

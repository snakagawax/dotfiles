---
description: 直前実行したカスタムコマンドの問題を分析・修正
allowed-tools: Read(**), Edit(**), Glob(**)
---

# カスタムコマンド修正

直前実行したカスタムコマンドの問題を分析し、修正を適用します。

## 引数

`$ARGUMENTS` - コマンドファイルパス（省略時は直前実行コマンドを自動検出）

## 実行手順

### Step 1: 対象コマンドの特定

#### 引数が指定されている場合

指定されたファイルパスのコマンドを読み込みます。

#### 引数が空の場合

ユーザーに直前実行したコマンドを確認します：

```
修正対象のコマンドはどれですか？

最近のコマンド:
- /work:daily-report
- /blog:draft-aws
- /git:draft-commit
```

### Step 2: 問題の確認

ユーザーに発生した問題を質問します：

```
どのような問題が発生しましたか？

よくある問題:
1. 意図しないファイル/ディレクトリを作成した
2. ツールがブロックされた（allowed-tools不足）
3. 期待と異なる出力だった
4. エラーが発生した
5. その他（具体的に説明してください）
```

### Step 3: コマンドファイルの分析

対象コマンドファイルを読み込み、以下を分析します：

#### 3-1: フロントマター確認

```yaml
---
description: ...
allowed-tools: ...
---
```

- `allowed-tools` が適切か
- 必要なツールが含まれているか

#### 3-2: 指示の曖昧さ検出

以下のパターンを検出：

| 問題パターン | 例 | 修正案 |
|-------------|-----|--------|
| 曖昧な出力先 | 「結果を保存」 | 「`~/.claude/output/` に保存」 |
| 禁止事項の欠如 | - | 「NEVER create directories」追加 |
| 条件分岐なし | 「ファイルを編集」 | 「ファイルが存在する場合のみ編集」 |
| 過度な自由度 | 「適宜処理」 | 具体的な手順を明示 |

#### 3-3: 根本原因の特定

| 症状 | 原因 | 対処 |
|------|------|------|
| ツールがブロック | allowed-tools不足 | ツール追加 |
| 勝手にファイル作成 | 禁止事項なし | NEVER句追加 |
| 期待と異なる出力 | 指示が曖昧 | 具体化 |
| 処理が途中で止まる | エラーハンドリングなし | 例外処理追加 |

### Step 4: 修正方針の提案

分析結果を基に修正方針を提案します：

```
📊 分析結果:

問題: {検出された問題}
原因: {根本原因}

📝 修正案:

1. {修正内容1}
2. {修正内容2}

この修正を適用しますか？
```

### Step 5: 修正の適用

ユーザーの承認後、Editツールで最小限の修正を適用します。

#### 修正時の追加パターン

**禁止事項の追加:**
```markdown
## 厳守事項

- NEVER create new directories
- NEVER modify files outside of `~/.claude/`
- MUST check file existence before editing
```

**出力先の明示:**
```markdown
## 出力

出力先: `{具体的なパス}`
```

**条件分岐の追加:**
```markdown
### Step X: ファイル確認

ファイルが存在する場合のみ以下を実行：
...

ファイルが存在しない場合：
「ファイルが見つかりません」とユーザーに報告
```

### Step 6: 完了報告

```
✅ コマンドを修正しました

📄 ファイル: {ファイルパス}

変更内容:
- {変更1}
- {変更2}

次回実行時に改善が反映されます。
```

---

## よくある問題と修正例

### 1. allowed-tools不足

**症状**: 「Tool X was not in allowed-tools」エラー

**修正**:
```yaml
# Before
allowed-tools: Read(**)

# After
allowed-tools: Read(**), Write(**), Bash(git:*)
```

### 2. 勝手にファイル作成

**症状**: 意図しないファイルやディレクトリが作成される

**修正**:
```markdown
# 追加する内容
## 厳守事項

- NEVER create new directories without explicit user request
- ONLY write to: `~/.claude/commands/` or specified output path
- MUST confirm with user before creating new files
```

### 3. 処理範囲が広すぎる

**症状**: 予期しないファイルまで処理される

**修正**:
```markdown
# Before
対象ディレクトリ内のファイルを処理

# After
対象: `~/.claude/commands/*.md` のみ
除外: `.git/`, `node_modules/`, 隠しファイル
```

### 4. エラー時の挙動が不明

**症状**: エラー発生時に処理が止まる

**修正**:
```markdown
## エラーハンドリング

### ファイルが見つからない場合
「指定されたファイルが見つかりません」と報告し、処理を中止

### 権限エラーの場合
エラー内容を表示し、代替手段を提案
```
